# 05. Spring Boot와 카프카 연동 - DLT 사후 처리

## 재시도조차 실패한 메시지 사후 처리하기

재시도까지 실패하여 `email.send.dlt`와 같은 DLT(Dead Letter Topic)에 저장된 메시지는 시스템이 자동으로 해결하지 못한 문제다. 따라서 이 메시지들을 직접 확인하고 적절한 조치를 취하는 과정이 필요하다.

### 1. DLT 메시지 사후 처리 방식

DLT에 저장된 메시지는 여러 번의 재시도를 거쳤음에도 실패한 것이므로 데이터나 환경에 문제가 있을 가능성이 높다. 현업에서는 주로 다음과 같은 단계로 처리한다.

1. **장애 원인 추적**: DLT에 저장된 메시지를 로그 시스템이나 모니터링 도구로 전송하여 원인을 파악한다.
2. **실시간 알림**: DLT에 메시지가 들어오는 즉시 관리자가 인지할 수 있도록 Slack, 이메일 등으로 알림을 보낸다.
3. **수동 조치**: 관리자는 분석된 원인에 따라 메시지를 다시 처리하거나 폐기한다.

#### 대표적인 수동 처리 예시
- **원래 토픽으로 재전송**: 일시적인 외부 서버 장애가 해결된 경우 메시지를 다시 메인 토픽으로 보내 처리한다.
- **메시지 폐기**: 데이터 형식이 잘못되었거나 탈퇴한 사용자 정보 등 처리가 불가능한 경우 로그를 남기고 폐기한다.
- **로직 보완**: 동일한 오류가 재발하지 않도록 프로듀서의 검증 로직이나 컨슈머의 예외 처리 로직을 수정한다.

---

### 2. DLT 메시지 처리 구현

별도의 컨슈머를 구성하여 DLT 토픽을 구독하고 로그 기록 및 알림 발송 로직을 수행할 수 있다.

#### EmailSendDltConsumer.java

```java
@Service
public class EmailSendDltConsumer {

    @KafkaListener(
        topics = "email.send.dlt",
        groupId = "email-send-dlt-group"
    )
    public void consume(String message) {
        // 실제 운영 환경에서는 로그 시스템(ELK 등)에 저장하거나 Slack 알림을 보낸다.
        System.out.println("[DLT Post-Processing] 로그 시스템에 전송: " + message);
        System.out.println("[DLT Post-Processing] Slack에 장애 알림 발송");
    }
}
```

---

### 3. 테스트 및 확인

1. **서버 실행 및 실패 유도**: `fail@naver.com` 주소로 요청을 보내 5회 재시도 후 DLT로 이동하게 만든다.
2. **DLT 컨슈머 동작 확인**:
    - 재시도가 모두 끝난 후, `EmailSendDltConsumer`가 동작하여 로그를 출력하는지 확인한다.
    - `[DLT Post-Processing] 로그 시스템에 전송` 문구가 터미널에 찍히면 정상적으로 처리된 것이다.

---

### 4. 정리

재시도조차 실패한 메시지를 DLT에 보관하고 이를 전용 컨슈머로 감시함으로써, 시스템은 비동기 처리 중 발생하는 최종 실패 케이스를 누락 없이 관리할 수 있다. 이를 통해 데이터의 신뢰성을 높이고 빠른 장애 대응이 가능해진다.
